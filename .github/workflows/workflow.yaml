name: Test Internal Kubernetes Service

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:

permissions:
  contents: write
  packages: write

jobs:
  test-internal:
    name: Build and Deploy to ChartMuseum
    runs-on: arc-runner-set  

    steps:
      - name: Checkout code
        uses: actions/checkout@v5.0.0

      - name: Setup Helm (action)
        uses: azure/setup-helm@v4.3.0

      - name: Adicionar repositório ChartMuseum
        run: |
          echo "Adicionando repositório ChartMuseum"
          helm repo add chartmuseum http://chartmuseum.default.svc.cluster.local:8080 || true
          helm repo list

      - name: Instalar plugin helm-push (ChartMuseum)
        run: |
          if ! helm plugin list | grep -q "push"; then
            helm plugin install https://github.com/chartmuseum/helm-push.git || true
          fi
          helm plugin list || true

      - name: Atualizar appVersion em Chart.yaml
        run: |
          ls -lha
          echo "Atualizando app-lab/Chart.yaml com o valor de $RANDOM"
          NEW_VER="$RANDOM"
          sed -i -E "s~^appVersion:.*~appVersion: \"${NEW_VER}\"~" app-lab/Chart.yaml || { echo "Falha ao atualizar app-lab/Chart.yaml"; exit 1; }
          grep '^appVersion' -n app-lab/Chart.yaml || true
          sed -i -E "s~^version:.*~version: \"${NEW_VER}\"~" app-lab/Chart.yaml || { echo "Falha ao atualizar app-lab/Chart.yaml"; exit 1; }
          grep '^version' -n app-lab/Chart.yaml || true
          echo "appVersion atualizado para: ${NEW_VER}"
          echo "version atualizado para: ${NEW_VER}"

      - name: Empacotar e enviar chart para ChartMuseum (helm push)
        run: |
          set -e
          echo "Empacotando chart app-lab"
          helm package app-lab || { echo "Falha ao empacotar o chart"; exit 1; }
          echo "Enviando chart para ChartMuseum"
          helm cm-push app-lab/ chartmuseum
          helm repo update || true
          helm repo list
          helm search repo chartmuseum  

      - name: Commit and push changes
        uses: stefanzweifel/git-auto-commit-action@v7
        with:
          commit_message: "chore: atualizar app-lab/Chart.yaml [ci skip]"
          branch: main
          file_pattern: "app-lab/Chart.yaml"
          commit_user_name: "github-actions"
          commit_user_email: "github-actions@users.noreply.github.com"
